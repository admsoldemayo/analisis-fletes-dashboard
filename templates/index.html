<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignador CPE - Pesadas</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "Segoe UI", sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 500px; width: 100%; }
        h1 { color: #1a1a2e; text-align: center; margin-bottom: 10px; font-size: 1.8rem; }
        .subtitle { color: #666; text-align: center; margin-bottom: 30px; font-size: 0.9rem; }
        .btn-group { display: flex; flex-direction: column; gap: 15px; }
        .btn { padding: 18px 30px; font-size: 1rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .btn-success:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(17, 153, 142, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .btn-warning:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4); }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .result { margin-top: 25px; padding: 20px; border-radius: 12px; display: none; }
        .result.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .result.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .result h3 { margin-bottom: 10px; }
        .result ul { list-style: none; padding: 0; }
        .result li { padding: 5px 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .result li:last-child { border-bottom: none; }
        .result li strong { display: inline-block; min-width: 150px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Asignador CPE - Pesadas</h1>
        <p class="subtitle">Match por Patente</p>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="ejecutar('asignar', this)">
                <span class="spinner"></span>
                <span class="text">1. Asignar CPEs a Pesadas</span>
            </button>
            <button class="btn btn-success" onclick="ejecutar('matchear-fletes', this)">
                <span class="spinner"></span>
                <span class="text">2. Pesadas -> Fletes (Neto)</span>
            </button>
            <button class="btn btn-warning" onclick="ejecutar('matchear-descargas', this)">
                <span class="spinner"></span>
                <span class="text">3. Descargas -> Fletes (Neto)</span>
            </button>
        </div>
        <div id="result" class="result"></div>
    </div>
    <script>
        async function ejecutar(endpoint, btn) {
            const spinner = btn.querySelector(".spinner");
            const text = btn.querySelector(".text");
            const resultDiv = document.getElementById("result");
            document.querySelectorAll(".btn").forEach(b => b.disabled = true);
            spinner.style.display = "inline-block";
            resultDiv.style.display = "none";
            try {
                const response = await fetch("/" + endpoint, { method: "POST", headers: { "Content-Type": "application/json" } });
                const data = await response.json();
                resultDiv.style.display = "block";
                if (data.success) {
                    resultDiv.className = "result success";
                    let html = "<h3>Proceso completado</h3><ul>";
                    for (const [key, value] of Object.entries(data)) {
                        if (key !== "success") {
                            const label = key.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
                            html += "<li><strong>" + label + ":</strong> " + value + "</li>";
                        }
                    }
                    html += "</ul>";
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.className = "result error";
                    resultDiv.innerHTML = "<h3>Error</h3><p>" + data.error + "</p>";
                }
            } catch (error) {
                resultDiv.style.display = "block";
                resultDiv.className = "result error";
                resultDiv.innerHTML = "<h3>Error</h3><p>" + error.message + "</p>";
            }
            document.querySelectorAll(".btn").forEach(b => b.disabled = false);
            spinner.style.display = "none";
        }
    </script>
</body>
</html>
